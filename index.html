<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connections</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #121213;
      color: #d7dadc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    h1 { margin-bottom: 20px; font-weight: 600; letter-spacing: 0.1em; }
    
    .solved-groups { width: 100%; max-width: 600px; margin-bottom: 10px; }
    
    .solved-group {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      text-align: center;
    }
    .solved-group .category { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
    .solved-group .words { font-size: 16px; text-transform: uppercase; }
    
    .group-yellow { background: #957f1b; color: #121213; }
    .group-green { background: #336d2e; color: #121213; }
    .group-blue { background: #1a5b9d; color: #121213; }
    .group-purple { background: #6b3b90; color: #121213; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    
    .tile {
      aspect-ratio: 2.5 / 1;
      background: #3a3a3c;
      border: none;
      border-radius: 8px;
      color: #d7dadc;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.1s, background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 8px;
    }
    
    .tile:hover { background: #4a4a4c; }
    .tile.selected { background: #5a5a5c; transform: scale(0.95); }
    
    .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    
    button {
      padding: 12px 24px;
      border: 1px solid #3a3a3c;
      border-radius: 24px;
      background: transparent;
      color: #d7dadc;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    button:hover { background: #3a3a3c; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    
    .message {
      min-height: 24px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .message.error { color: #e74c3c; }
    .message.success { color: #538d4e; }
    
    .mistakes {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 14px;
    }
    .mistake-dot {
      width: 12px;
      height: 12px;
      background: #3a3a3c;
      border-radius: 50%;
    }
    .mistake-dot.used { background: #555; }
  </style>
</head>
<body>
  <h1>CONNECTIONS</h1>
  <div class="solved-groups" id="solved"></div>
  <div class="grid" id="grid"></div>
  <div class="message" id="message"></div>
  <div class="controls">
    <button id="shuffle">Shuffle</button>
    <button id="deselect">Deselect All</button>
    <button id="submit" disabled>Submit</button>
  </div>
  <div class="mistakes">
    Mistakes remaining:
    <span id="mistakes"></span>
  </div>

  <script>
    const colors = ["yellow", "green", "blue", "purple"];
    
    let tiles = [];
    let selected = new Set();
    let solved = [];
    let mistakes = 4;
    let groups = [];

    const grid = document.getElementById('grid');
    const solvedDiv = document.getElementById('solved');
    const messageDiv = document.getElementById('message');
    const mistakesDiv = document.getElementById('mistakes');
    const submitBtn = document.getElementById('submit');

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function loadPuzzle() {
      const today = new Date().toISOString().slice(0, 10);
      try {
        const response = await fetch(`https://corsproxy.io/?https://www.nytimes.com/svc/connections/v2/${today}.json`);
        const data = await response.json();
        
        // Assign random colors
        const shuffledColors = [...colors];
        
        groups = data.categories.map((cat, i) => ({
          category: cat.title,
          words: cat.cards.map(c => c.content),
          color: shuffledColors[i]
        }));
        
        tiles = groups.flatMap(g => g.words.map(w => ({ word: w, group: g })));
        shuffle(tiles);
        render();
      } catch (err) {
        messageDiv.textContent = 'Failed to load puzzle. Check console for details.';
        messageDiv.className = 'message error';
        console.error('Failed to load puzzle:', err);
      }
    }

    function render() {
      grid.innerHTML = '';
      tiles.forEach(tile => {
        const btn = document.createElement('button');
        btn.className = 'tile' + (selected.has(tile.word) ? ' selected' : '');
        btn.textContent = tile.word;
        btn.onclick = () => toggleSelect(tile.word);
        grid.appendChild(btn);
      });

      mistakesDiv.innerHTML = Array(4).fill(0)
        .map((_, i) => `<span class="mistake-dot${i >= mistakes ? ' used' : ''}"></span>`)
        .join('');

      submitBtn.disabled = selected.size !== 4;
    }

    function toggleSelect(word) {
      if (selected.has(word)) {
        selected.delete(word);
      } else if (selected.size < 4) {
        selected.add(word);
      }
      render();
    }

    function showMessage(text, type = '') {
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      if (text) setTimeout(() => { messageDiv.textContent = ''; messageDiv.className = 'message'; }, 2000);
    }

    document.getElementById('shuffle').onclick = () => {
      // Partition into selected and unselected
      const selectedTiles = tiles.filter(t => selected.has(t.word));
      const unselectedTiles = tiles.filter(t => !selected.has(t.word));
      
      // Shuffle each partition
      shuffle(selectedTiles);
      shuffle(unselectedTiles);
      
      // Selected first, then unselected
      tiles = [...selectedTiles, ...unselectedTiles];
      render();
    };

    document.getElementById('deselect').onclick = () => {
      selected.clear();
      render();
    };

    submitBtn.onclick = () => {
      const selectedTiles = tiles.filter(t => selected.has(t.word));
      const groups = new Map();
      selectedTiles.forEach(t => {
        groups.set(t.group, (groups.get(t.group) || 0) + 1);
      });

      if (groups.size === 1 && [...groups.values()][0] === 4) {
        // Correct!
        const group = selectedTiles[0].group;
        solved.push(group);
        tiles = tiles.filter(t => !selected.has(t.word));
        selected.clear();

        const div = document.createElement('div');
        div.className = `solved-group group-${group.color}`;
        div.innerHTML = `<div class="category">${group.category}</div><div class="words">${group.words.join(', ')}</div>`;
        solvedDiv.appendChild(div);

        if (tiles.length === 0) {
          showMessage('Congratulations!', 'success');
        }
      } else {
        // Check for "one away"
        const maxMatch = Math.max(...groups.values());
        if (maxMatch === 3) {
          showMessage('One away...', 'error');
        } else {
          showMessage('Incorrect', 'error');
        }
        mistakes--;
        if (mistakes === 0) {
          showMessage('Game over!', 'error');
          document.querySelectorAll('button').forEach(b => b.disabled = true);
        }
      }
      render();
    };

    // Load today's puzzle
    loadPuzzle();
  </script>
</body>
</html>
